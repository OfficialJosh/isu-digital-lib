name: Deploy ISU Semantic Search

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Authenticate to Google Cloud
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Create a Cloud Build configuration file with hardcoded values
      - name: Create Cloud Build config
        run: |
          cat > cloudbuild.yaml <<EOF
          steps:
            # Install dependencies
            - name: 'node:19'
              entrypoint: npm
              args: ['ci']
              dir: 'frontend'
              
            # Build the Next.js application
            - name: 'node:19'
              entrypoint: npm
              args: ['run', 'build']
              dir: 'frontend'
              
            # Build the container
            - name: 'gcr.io/cloud-builders/docker'
              args: [
                'build',
                '-t', 'gcr.io/$PROJECT_ID/isu-semantic-search:$COMMIT_SHA',
                '-t', 'gcr.io/$PROJECT_ID/isu-semantic-search:latest',
                'frontend/'
              ]
              
            # Push the container image to Container Registry
            - name: 'gcr.io/cloud-builders/docker'
              args: ['push', 'gcr.io/$PROJECT_ID/isu-semantic-search:$COMMIT_SHA']
              
            # Deploy container image to Cloud Run
            - name: 'gcr.io/cloud-builders/gcloud'
              args:
                - 'run'
                - 'deploy'
                - 'isu-digital-lib'
                - '--image'
                - 'gcr.io/$PROJECT_ID/isu-semantic-search:$COMMIT_SHA'
                - '--region'
                - 'us-central1'
                - '--platform'
                - 'managed'
                - '--allow-unauthenticated'
          EOF

      # Submit the Cloud Build job without any substitutions
      - name: Submit to Cloud Build
        run: |
          gcloud builds submit --config=cloudbuild.yaml